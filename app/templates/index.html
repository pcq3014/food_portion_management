<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Nhật Ký Ăn Uống</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Header mới -->
  <header class="flex items-center justify-between px-8 py-4 bg-gradient-to-r from-blue-500 via-green-400 to-yellow-300 shadow-lg sticky top-0 z-40">
    <div class="flex items-center gap-4">
      <img src="/static/logo.png" class="w-12 h-12 rounded-full border-4 border-white shadow" alt="Logo" />
      <button onclick="goHome()" class="text-3xl font-extrabold text-white tracking-wide flex items-center gap-2 focus:outline-none">
  <span></span> SmartCalories
</button>
    </div>
    <div class="flex items-center gap-4">
      <span class="text-white font-semibold text-lg flex items-center gap-2">
        <span>👤</span> {{ fullname }}
      </span>
      <a href="/logout" class="bg-white/20 hover:bg-white/40 text-white px-4 py-2 rounded-xl font-bold shadow transition flex items-center gap-2">
        <span>🚪</span> Đăng xuất
      </a>
    </div>
  </header>
  <!-- Dashboard layout -->
  <main class="flex h-[calc(100vh-80px)] transition-all duration-300 ease-in-out">
    <!-- Sidebar -->
<aside class="w-64 bg-gradient-to-b from-blue-700 via-blue-500 to-blue-400 text-white p-4 space-y-2 shadow-lg">
  <nav class="flex flex-col gap-1">
    <button onclick="switchView('meals')" id="btn-meals"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
      📋 <span>Danh sách món</span>
    </button>
    <button onclick="switchView('log')" id="btn-log"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
      📖 <span>Nhật ký & Phân tích</span>
    </button>
    <button onclick="openSuggestModal()"
  class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
  🥗 <span>Gợi ý món ăn</span>
</button>
    <button onclick="openLogMealModal()"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
      📝 <span>Ghi nhật ký</span>
    </button>
    <button onclick="openAddMealModal()"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
      ➕ <span>Thêm món</span>
    </button>
    <button onclick="openProfileModal()"
  class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none">
  👤 <span>Thông tin cá nhân</span>
</button>
    <div class="relative group">
  <button class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-medium focus:outline-none w-full">
    📤 <span>Xuất CSV</span>
  </button>
  <div class="absolute left-0 mt-1 hidden group-hover:block bg-white text-gray-800 shadow-lg rounded-lg overflow-hidden z-10 w-48">
    <a href="/export-csv?mode=today" class="block px-4 py-2 hover:bg-blue-100">📆 Xuất hôm nay</a>
    <a href="/export-csv?mode=all" class="block px-4 py-2 hover:bg-blue-100">📦 Xuất tất cả</a>
  </div>
</div>
  </nav>
</aside>



    <!-- Content Area -->
    <section class="flex-1 overflow-y-auto p-6">
      <!-- Meals View -->
      <div id="mealsView" class="hidden">
  <h2 class="text-2xl font-bold mb-4">📋 Danh sách món ăn</h2>
  <form method="get" action="/" class="mb-4 flex gap-2">
    <input type="text" name="search" placeholder="Tìm món ăn..." value="{{ search | default('') }}"
      class="border border-gray-300 rounded-lg px-3 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-blue-400 transition" />
    <input type="hidden" name="view" value="meals" />
    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition">Tìm kiếm</button>
  </form>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
  {% for meal in meals %}
  <div class="bg-white p-4 rounded-xl shadow">
    {% if meal.image_url %}
      <img src="{{ meal.image_url }}" alt="{{ meal.name }}" class="w-full h-40 object-cover rounded-lg mb-3" />
    {% else %}
      <div class="w-full h-40 bg-gray-200 rounded-lg flex items-center justify-center mb-3 text-gray-500">Không có ảnh</div>
    {% endif %}
    <h3 class="text-lg font-semibold">{{ meal.name }}</h3>
    <ul class="text-sm mt-2 text-gray-600">
      <li>🔥 Calories: {{ meal.calories }}</li>
      <li>💪 Protein: {{ meal.protein }}g</li>
      <li>🍞 Carbs: {{ meal.carbs }}g</li>
      <li>🥑 Fat: {{ meal.fat }}g</li>
    </ul>
    <div class="mt-4 flex gap-3">
      <button class="editMealBtn text-blue-600" data-meal='{{ meal | tojson }}'>✏️ Sửa</button>
      <button onclick="openModal('{{ meal._id }}')" class="text-red-600">🗑️ Xoá</button>
    </div>
  </div>
  {% endfor %}
</div>
        </div>

        <!-- Logs and Analytics View -->
        <div id="logView" class="hidden">
          <h2 class="text-2xl font-bold mb-4">🗓️ Nhật ký hôm nay</h2>
          <div class="bg-white rounded-xl shadow overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-blue-700 text-white font-semibold">
  <tr>
    <th class="p-3 text-center border border-blue-800">Món</th>
    <th class="p-3 text-center border border-blue-800">Số lượng</th>
    <th class="p-3 text-center border border-blue-800">Calories</th>
    <th class="p-3 text-center border border-blue-800">Protein</th>
    <th class="p-3 text-center border border-blue-800">Carbs</th>
    <th class="p-3 text-center border border-blue-800">Fat</th>
  </tr>
</thead>
<tbody>
  {% for log in logs %}
  <tr class="even:bg-blue-50 odd:bg-white">
    <td class="p-3 text-center border border-blue-200">{{ log.meal.name }}</td>
    <td class="p-3 text-center border border-blue-200">{{ log.quantity }}</td>
    <td class="p-3 text-center border border-blue-200">{{ log.meal.calories * log.quantity }}</td>
    <td class="p-3 text-center border border-blue-200">{{ log.meal.protein * log.quantity }}</td>
    <td class="p-3 text-center border border-blue-200">{{ log.meal.carbs * log.quantity }}</td>
    <td class="p-3 text-center border border-blue-200">{{ log.meal.fat * log.quantity }}</td>
  </tr>
  {% endfor %}
</tbody>
            </table>
          </div>

          <h2 class="text-2xl font-bold mt-10 mb-4">📊 Phân tích hôm nay</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow">
              <h3 class="text-lg font-semibold mb-2">📈 Dinh dưỡng tổng</h3>
              <canvas id="nutritionChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow">
              <h3 class="text-lg font-semibold mb-2">🥗 Phân bố chất</h3>
              <canvas id="macroPieChart"></canvas>
            </div>
          </div>
        </div>
        <div id="welcomeView" class="flex flex-col items-center justify-center h-full text-center text-gray-700 space-y-4">
  <img src="/static/trangchu.png" alt="Welcome" class="w-40 h-40">
  <h1 class="text-3xl font-bold">Chào mừng đến với SmartCalories! 🥗</h1>
  <p class="text-lg">Hãy chọn một mục từ menu bên trái để bắt đầu quản lý khẩu phần ăn của bạn.</p>
</div>
      </section>
    </main>

    <!-- JS Script -->
    <script>
      const summary = {
        calories: {{ summary.total_calories | default(0) }},
        protein: {{ summary.total_protein | default(0) }},
        carbs: {{ summary.total_carbs | default(0) }},
        fat: {{ summary.total_fat | default(0) }},
      };

      function switchView(view) {
        document.getElementById("mealsView").classList.add("hidden");
        document.getElementById("logView").classList.add("hidden");
        document.getElementById(view + "View").classList.remove("hidden");
      }

      window.onload = () => {
    // Ẩn tất cả view ban đầu
    document.getElementById("mealsView").classList.add("hidden");
    document.getElementById("logView").classList.add("hidden");
  };

      new Chart(document.getElementById("nutritionChart"), {
    type: 'bar',
    data: {
      labels: ['Calories', 'Protein', 'Carbs', 'Fat'],
      datasets: [{
        label: 'Dinh dưỡng hôm nay',
        data: [summary.calories, summary.protein, summary.carbs, summary.fat],
        backgroundColor: [
          'rgba(248,113,113,0.85)', // đỏ nhạt
          'rgba(96,165,250,0.85)',  // xanh dương
          'rgba(250,204,21,0.85)',  // vàng
          'rgba(52,211,153,0.85)'   // xanh lá
        ],
        borderRadius: 12,
        borderWidth: 2,
        borderColor: [
          '#ef4444', '#2563eb', '#ca8a04', '#059669'
        ],
        maxBarThickness: 60
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return `${ctx.label}: ${ctx.parsed.y} ${ctx.label === 'Calories' ? '' : 'g'}`;
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { font: { size: 16, weight: 'bold' } }
        },
        y: {
          beginAtZero: true,
          grid: { color: '#e5e7eb' },
          ticks: { font: { size: 14 } }
        }
      }
    }
  });

  // Macro Pie Chart
  new Chart(document.getElementById("macroPieChart"), {
    type: 'doughnut',
    data: {
      labels: ['Protein', 'Carbs', 'Fat'],
      datasets: [{
        data: [summary.protein, summary.carbs, summary.fat],
        backgroundColor: [
          'rgba(59,130,246,0.85)', // xanh dương
          'rgba(253,224,71,0.85)', // vàng nhạt
          'rgba(16,185,129,0.85)'  // xanh lá
        ],
        borderColor: ['#2563eb', '#ca8a04', '#059669'],
        borderWidth: 2,
        hoverOffset: 16
      }]
    },
    options: {
      responsive: true,
      cutout: '65%',
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
          labels: {
            font: { size: 15, weight: 'bold' },
            color: '#374151'
          }
        },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
              const value = ctx.parsed;
              const percent = total ? ((value / total) * 100).toFixed(1) : 0;
              return `${ctx.label}: ${value}g (${percent}%)`;
            }
          }
        },
        title: {
          display: false
        }
      }
    }
  });
</script>
    <!-- Modal Ghi Nhật Ký -->
  <div id="logMealModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out">
    <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md space-y-4">
      <h2 class="text-2xl font-bold text-green-600 flex items-center gap-2">
        <span>📝</span> Ghi nhật ký
      </h2>
      <form action="/log-meal" method="POST" class="space-y-3">
        <select name="meal_id" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition" required>
          {% for meal in meals %}
          <option value="{{ meal._id }}">{{ meal.name }}</option>
          {% endfor %}
        </select>
        <input name="quantity" type="number" placeholder="Số lượng" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition" required>
        <input name="date" type="date" value="{{ today }}" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition" required>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="closeLogMealModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition">Huỷ</button>
          <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition">Lưu</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    function openLogMealModal() {
      document.getElementById('logMealModal').classList.remove('hidden');
    }
    function closeLogMealModal() {
      document.getElementById('logMealModal').classList.add('hidden');
    }
  </script>
  <!-- Modal Thêm Món Ăn -->
  <div id="addMealModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out">
    <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md space-y-4">
      <h2 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
        <span>➕</span> Thêm món ăn
      </h2>
      <form action="/add-meal" method="POST" class="space-y-3">
        <div>
          <label for="addName" class="block mb-1 font-medium text-gray-700">Tên món</label>
          <input name="name" id="addName" placeholder="Tên món ăn" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="addCalories" class="block mb-1 font-medium text-gray-700">Calories</label>
            <input name="calories" id="addCalories" type="number" placeholder="Calories" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
          <div>
            <label for="addProtein" class="block mb-1 font-medium text-gray-700">Protein (g)</label>
            <input name="protein" id="addProtein" type="number" placeholder="Protein (g)" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
          <div>
            <label for="addCarbs" class="block mb-1 font-medium text-gray-700">Carbs (g)</label>
            <input name="carbs" id="addCarbs" type="number" placeholder="Carbs (g)" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
          <div>
            <label for="addFat" class="block mb-1 font-medium text-gray-700">Fat (g)</label>
            <input name="fat" id="addFat" type="number" placeholder="Fat (g)" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required>
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="closeAddMealModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition">Huỷ</button>
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition">Thêm</button>
        </div>
        <div>
  <label for="addImageUrl" class="block mb-1 font-medium text-gray-700">Link ảnh (tuỳ chọn)</label>
  <input name="image_url" id="addImageUrl" type="url" placeholder="https://..." class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
</div>
      </form>
    </div>
  </div>
  <script>
    function openAddMealModal() {
      document.getElementById('addMealModal').classList.remove('hidden');
    }
    function closeAddMealModal() {
      document.getElementById('addMealModal').classList.add('hidden');
    }
  </script>
  <!-- Modal sửa món ăn -->
  <div id="editMealModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out">
    <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-md space-y-4">
      <h2 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
        <span>✏️</span> Sửa món ăn
      </h2>
      <form id="editMealForm" method="POST" class="space-y-3">
        <input type="hidden" name="meal_id" id="editMealId" />
        <div>
          <label for="editName" class="block mb-1 font-medium text-gray-700">Tên món</label>
          <input type="text" id="editName" name="name" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="editCalories" class="block mb-1 font-medium text-gray-700">Calories</label>
            <input type="number" id="editCalories" name="calories" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
          <div>
            <label for="editProtein" class="block mb-1 font-medium text-gray-700">Protein (g)</label>
            <input type="number" id="editProtein" name="protein" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
          <div>
            <label for="editCarbs" class="block mb-1 font-medium text-gray-700">Carbs (g)</label>
            <input type="number" id="editCarbs" name="carbs" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
          <div>
            <label for="editFat" class="block mb-1 font-medium text-gray-700">Fat (g)</label>
            <input type="number" id="editFat" name="fat" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" required />
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="closeEditMealModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition">Huỷ</button>
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition">Lưu</button>
        </div>
        <div>
  <label for="editImageUrl" class="block mb-1 font-medium text-gray-700">Link ảnh (tuỳ chọn)</label>
  <input type="url" id="editImageUrl" name="image_url" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition" />
</div>
      </form>
    </div>
  </div>
  <script>
    function openEditMealModal(meal) {
      document.getElementById('editMealId').value = meal._id;
      document.getElementById('editName').value = meal.name;
      document.getElementById('editCalories').value = meal.calories;
      document.getElementById('editProtein').value = meal.protein;
      document.getElementById('editCarbs').value = meal.carbs;
      document.getElementById('editFat').value = meal.fat;
      document.getElementById('editImageUrl').value = meal.image_url || ""; 
      document.getElementById('editMealForm').action = '/edit-meal/' + meal._id;
      document.getElementById('editMealModal').classList.remove('hidden');
    }
    document.querySelectorAll('.editMealBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        const meal = JSON.parse(btn.dataset.meal);
        openEditMealModal(meal);
      });
    });
    function closeEditMealModal() {
      document.getElementById('editMealModal').classList.add('hidden');
    }
  </script>
  <!-- Modal xác nhận xoá -->
  <div id="deleteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-sm">
      <h2 class="text-xl font-semibold mb-4">🗑️ Xác nhận xoá</h2>
      <p class="text-gray-700 mb-4">Bạn có chắc chắn muốn xoá món ăn này?</p>
      <div class="flex justify-end gap-3">
        <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded">Huỷ</button>
        <form id="confirmDeleteForm" method="POST">
          <button type="submit" class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">Xoá</button>
        </form>
      </div>
    </div>
  </div>
  <script>
    function openModal(mealId) {
      const modal = document.getElementById("deleteModal");
      const form = document.getElementById("confirmDeleteForm");
      form.action = "/delete-meal/" + mealId;
      modal.classList.remove("hidden");
    }
    function closeModal() {
      document.getElementById("deleteModal").classList.add("hidden");
    }
  </script>
  <!-- Modal Gợi ý món ăn -->
<div id="suggestModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-3xl max-h-[90vh] overflow-hidden p-6 flex flex-col">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-yellow-700 flex items-center gap-2">
        🥗 Gợi ý món ăn & Đặt mục tiêu
      </h2>
      <button onclick="closeSuggestModal()" class="text-gray-500 hover:text-red-500 text-2xl font-bold">&times;</button>
    </div>
    <!-- Form đặt mục tiêu -->
    <form method="post" action="/set-goals"
      class="flex gap-2 items-end mb-4 bg-blue-50 p-3 rounded-lg shadow"
      id="goalsForm"
      onsubmit="return submitGoalsForm(event)">
      <div>
  <label class="block text-xs font-bold mb-1">Calories</label>
  <input type="number" name="calories" value="0" min="0" class="border rounded px-2 py-1 w-20" required />
</div>
<div>
  <label class="block text-xs font-bold mb-1">Protein</label>
  <input type="number" name="protein" value="0" min="0" class="border rounded px-2 py-1 w-20" required />
</div>
<div>
  <label class="block text-xs font-bold mb-1">Carbs</label>
  <input type="number" name="carbs" value="0" min="0" class="border rounded px-2 py-1 w-20" required />
</div>
<div>
  <label class="block text-xs font-bold mb-1">Fat</label>
  <input type="number" name="fat" value="0" min="0" class="border rounded px-2 py-1 w-20" required />
</div>
      <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded font-bold">Tìm kiếm</button>
</form>
    <!-- Thông báo lượng còn thiếu -->
    <div class="mb-3 text-sm text-gray-700">
  Đang thiếu:
  <span class="font-semibold text-red-600" id="missingCalories">Calories: {{ missing.calories }}</span>,
  <span class="font-semibold text-blue-600" id="missingProtein">Protein: {{ missing.protein }}</span>,
  <span class="font-semibold text-yellow-600" id="missingCarbs">Carbs: {{ missing.carbs }}</span>,
  <span class="font-semibold text-green-600" id="missingFat">Fat: {{ missing.fat }}</span>
</div>
<!-- Gợi ý món ăn -->
<div class="overflow-y-auto space-y-4 pr-2" id="suggestedMealGroups" style="max-height: 60vh;"></div>
</ul>
  <div class="text-xs text-gray-500 mt-2">* Gợi ý dựa trên chất còn thiếu nhiều nhất hôm nay</div>
</div>
  </div>
</div>
<script>
  function openSuggestModal() {
  document.getElementById('suggestModal').classList.remove('hidden');
  document.querySelector('input[name="calories"]').value = 0;
  document.querySelector('input[name="protein"]').value = 0;
  document.querySelector('input[name="carbs"]').value = 0;
  document.querySelector('input[name="fat"]').value = 0;
  // Reset các giá trị "Đang thiếu" về 0
  document.getElementById('missingCalories').textContent = "Calories: 0";
  document.getElementById('missingProtein').textContent = "Protein: 0";
  document.getElementById('missingCarbs').textContent = "Carbs: 0";
  document.getElementById('missingFat').textContent = "Fat: 0";
  // Xoá gợi ý món ăn cũ
  document.getElementById('suggestedMealGroups').innerHTML = "";
}
  // Nếu muốn submit form không reload trang, có thể dùng AJAX ở đây
</script>
<script>
  function openSuggestModal() {
    document.getElementById('suggestModal').classList.remove('hidden');
  }
  function closeSuggestModal() {
    document.getElementById('suggestModal').classList.add('hidden');
  }
</script>
<!-- Modal Thông tin cá nhân -->
<div id="profileModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
  <div class="bg-white p-8 rounded-xl shadow space-y-4 w-full max-w-md relative">
    <button onclick="closeProfileModal()" class="absolute top-2 right-3 text-2xl text-gray-400 hover:text-red-500 font-bold">&times;</button>
    <h2 class="text-2xl font-bold mb-4">Thông tin cá nhân</h2>
    <!-- Chế độ chỉ đọc -->
    <div id="profileNotice" class="hidden mb-2 px-4 py-2 rounded text-white font-semibold"></div>
    
    <div id="profileViewMode">
      <div class="mb-4 flex justify-center">
      <img id="viewAvatar" src="{{ user.avatar_url or '' }}" alt="Avatar" class="w-24 h-24 rounded-full border-4 border-blue-300 shadow" />
      </div>
      <div class="mb-2"><b>Họ tên:</b> <span id="viewFullname">{{ fullname }}</span></div>
      <div class="mb-2"><b>Chiều cao:</b> <span id="viewHeight">{{ user.height or "Chưa cập nhật" }}</span> cm</div>
      <div class="mb-2"><b>Cân nặng:</b> <span id="viewWeight">{{ user.weight or "Chưa cập nhật" }}</span> kg</div>
      <div class="mb-2"><b>Tuổi:</b> <span id="viewAge">{{ user.age or "Chưa cập nhật" }}</span></div>
      <div class="mb-2"><b>Giới tính:</b> <span id="viewGender">
        {% if user.gender == "male" %}Nam{% elif user.gender == "female" %}Nữ{% else %}Chưa cập nhật{% endif %}
      </span></div>
      <div class="mb-2"><b>BMR:</b> <span id="viewBmr">{{ bmr if bmr else "Chưa có" }}</span> kcal/ngày</div>
      <div class="mb-2"><b>TDEE:</b> <span id="viewTdee">{{ tdee if tdee else "Chưa có" }}</span> kcal/ngày</div>
      <button onclick="switchToEditProfile()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded font-bold w-full">Chỉnh sửa</button>
    </div>
    <!-- Chế độ chỉnh sửa -->
    <form id="profileForm" method="post" class="space-y-3 hidden" onsubmit="return submitProfileForm(event)" enctype="multipart/form-data">
  <div>
    <label class="block mb-1">Chiều cao (cm):</label>
    <input type="number" name="height" id="profileHeight" required class="border rounded px-3 py-2 w-full" />
  </div>
  <div>
    <label class="block mb-1">Cân nặng (kg):</label>
    <input type="number" name="weight" id="profileWeight" required class="border rounded px-3 py-2 w-full" />
  </div>
  <div>
    <label class="block mb-1">Tuổi:</label>
    <input type="number" name="age" id="profileAge" required class="border rounded px-3 py-2 w-full" />
  </div>
  <div>
    <label class="block mb-1">Giới tính:</label>
    <select name="gender" id="profileGender" required class="border rounded px-3 py-2 w-full">
      <option value="male">Nam</option>
      <option value="female">Nữ</option>
    </select>
  </div>
  <div>
    <label class="block mb-1">Chọn ảnh đại diện:</label>
    <input type="file" id="profileAvatarFile" accept="image/*" class="border rounded px-3 py-2 w-full" />
  </div>
  <div>
    <label class="block mb-1">Hoặc link ảnh đại diện:</label>
    <input type="url" name="avatar_url" id="profileAvatarUrl" placeholder="https://..." class="border rounded px-3 py-2 w-full" />
  </div>
  <div class="flex gap-2">
    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded font-bold w-full">Lưu</button>
    <button type="button" onclick="switchToViewProfile()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded font-bold w-full">Hủy</button>
  </div>
</form>
  </div>
</div>
<style>
.sidebar.collapsed > *:not(#sidebarToggleBtn):not(.w-full) {
  display: none !important;
}
.sidebar.collapsed .w-full > *:not(img) {
  display: none !important;
}
.sidebar.collapsed .w-full img {
  width: 2.5rem !important;
  height: 2.5rem !important;
}
.sidebar.collapsed {
  width: 4rem !important;
  padding-left: 0.5rem !important;
  padding-right: 0.5rem !important;
  overflow: hidden !important;
}
.sidebar.collapsed nav {
  display: none !important;
}
.sidebar.collapsed button[onclick*="toggleSidebar"] {
  left: 40px !important;
  right: auto !important;
}
  /* Khi sidebar bị collapse */
  #sidebar.collapsed {
    width: 4rem; /* w-16 */
  }
  #sidebar.collapsed .sidebar-text {
    display: none;
  }
  .sidebar-btn {
  @apply flex items-center gap-3 px-4 py-3 rounded-xl font-semibold text-white bg-gradient-to-r from-blue-400 to-green-400 shadow hover:from-green-400 hover:to-blue-400 hover:scale-105 transition-all duration-200;
  margin-bottom: 0.25rem;
  border: none;
  outline: none;
  cursor: pointer;
}
.sidebar-btn:active {
  @apply scale-95;
}
.sidebar-btn .sidebar-text {
  @apply transition-all duration-200;
}
.sidebar.collapsed .sidebar-text {
  display: none !important;
}
.sidebar.collapsed .sidebar-btn {
  justify-content: center;
  padding-left: 0.5rem;
  padding-right: 0.5rem;
}
.sidebar.collapsed .w-full > *:not(img) {
  display: none !important;
}
.sidebar.collapsed .w-full img {
  width: 2.5rem !important;
  height: 2.5rem !important;
}
.sidebar.collapsed {
  width: 4rem !important;
  padding-left: 0.5rem !important;
  padding-right: 0.5rem !important;
  overflow: hidden !important;
}
.sidebar.collapsed nav {
  display: block !important;
}

#sidebar.collapsed {
  width: 4rem;
}
#sidebar.collapsed .sidebar-text {
  display: none;
}
  .sidebar-btn {
    @apply flex items-center gap-3 px-4 py-3 rounded-xl text-white font-medium transition-all duration-200 ease-in-out hover:bg-blue-500/50 focus:outline-none;
  }
  .sidebar-btn.active {
    @apply bg-white text-blue-700 shadow-md font-semibold;
  }
  .sidebar-text {
    @apply whitespace-nowrap;
  }
</style>
<script>
  function switchView(view) {
    // Ẩn tất cả view
    document.getElementById("welcomeView").classList.add("hidden");
    document.getElementById("mealsView").classList.add("hidden");
    document.getElementById("logView").classList.add("hidden");

    // Hiện view tương ứng
    document.getElementById(view + "View").classList.remove("hidden");

    // Cập nhật trạng thái active cho sidebar
    document.querySelectorAll("aside button").forEach(btn => {
      btn.classList.remove("bg-white", "text-blue-700", "font-semibold", "shadow-md");
    });
    const activeBtn = document.getElementById("btn-" + view);
    if (activeBtn) {
      activeBtn.classList.add("bg-white", "text-blue-700", "font-semibold", "shadow-md");
    }
  }

  function goHome() {
    // Ẩn tất cả
    document.getElementById("mealsView").classList.add("hidden");
    document.getElementById("logView").classList.add("hidden");
    document.getElementById("welcomeView").classList.remove("hidden");

    // Xoá trạng thái active
    document.querySelectorAll("aside button").forEach(btn => {
      btn.classList.remove("bg-white", "text-blue-700", "font-semibold", "shadow-md");
    });
  }

  window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    const view = params.get("view");

    document.getElementById("mealsView").classList.add("hidden");
    document.getElementById("logView").classList.add("hidden");
    document.getElementById("welcomeView").classList.add("hidden");

    if (view === "log") {
      switchView("log");
    } else if (view === "meals") {
      switchView("meals");
    } else {
      document.getElementById("welcomeView").classList.remove("hidden");
    }
  };
</script>
<script>
function submitGoalsForm(event) {
  event.preventDefault();
  const form = document.getElementById('goalsForm');
  const formData = new FormData(form);

  fetch('/set-goals', {
    method: 'POST',
    body: formData,
    credentials: 'same-origin'
  })
  .then(res => res.json())
  .then(data => {
    // Cập nhật lượng còn thiếu
    document.getElementById('missingCalories').textContent = "Calories: " + data.missing.calories;
    document.getElementById('missingProtein').textContent = "Protein: " + data.missing.protein;
    document.getElementById('missingCarbs').textContent = "Carbs: " + data.missing.carbs;
    document.getElementById('missingFat').textContent = "Fat: " + data.missing.fat;

    const container = document.getElementById('suggestedMealGroups');
    container.innerHTML = "";

    const nutrientLabels = {
      calories: "🍚 Calories",
      protein: "💪 Protein",
      carbs: "🍞 Carbs",
      fat: "🥑 Fat"
    };

    Object.keys(data.suggested_meals).forEach(nutrient => {
      const group = document.createElement('div');

      const toggleBtn = document.createElement('button');
      toggleBtn.textContent = `Ẩn/Hiện gợi ý ${nutrientLabels[nutrient]}`;
      toggleBtn.className = "mb-2 text-sm font-semibold bg-yellow-200 px-3 py-1 rounded shadow hover:bg-yellow-300";
      
      const list = document.createElement('div');
      list.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4";
      list.id = `group-${nutrient}`;

      toggleBtn.onclick = () => {
        list.classList.toggle("hidden");
      };

      const title = document.createElement('div');
      title.className = "font-semibold text-yellow-700 mt-2 mb-1";
      title.textContent = `Gợi ý theo ${nutrientLabels[nutrient]} còn thiếu:`;

      const meals = data.suggested_meals[nutrient];
      if (meals.length === 0) {
        const msg = document.createElement("div");
        msg.className = "text-gray-500 italic col-span-3";
        msg.textContent = "Không có món phù hợp.";
        list.appendChild(msg);
      } else {
        meals.forEach(meal => {
          const card = document.createElement("div");
          card.className = "bg-yellow-50 p-3 rounded-lg shadow text-center";

          if (meal.image_url) {
            const img = document.createElement("img");
            img.src = meal.image_url + "?t=" + new Date().getTime();
            img.alt = meal.name;
            img.className = "w-full h-24 object-cover rounded mb-2";
            card.appendChild(img);
          }

          const name = document.createElement("div");
          name.className = "font-bold text-blue-700 mb-1";
          name.textContent = meal.name;
          card.appendChild(name);

          const info = document.createElement("div");
          info.className = "text-sm text-gray-600";
          info.innerHTML = `🔥 ${meal.calories} cal<br>💪 ${meal.protein}g • 🍞 ${meal.carbs}g • 🥑 ${meal.fat}g`;
          card.appendChild(info);

          list.appendChild(card);
        });
      }

      group.appendChild(toggleBtn);
      group.appendChild(title);
      group.appendChild(list);
      container.appendChild(group);
    });
  });

  return false;
}
</script>
<script>
  // Lấy thông tin user từ backend (Jinja2)
  const userProfile = {
  fullname: "{{ fullname }}",
    height: {{ user.height if user and user.height is defined else 'null' }},
    weight: {{ user.weight if user and user.weight is defined else 'null' }},
    age: {{ user.age if user and user.age is defined else 'null' }},
    gender: "{{ user.gender if user and user.gender is defined else '' }}",
    bmr: {{ bmr if bmr is defined and bmr else 'null' }},
    tdee: {{ tdee if tdee is defined and tdee else 'null' }},
    avatar_url: "{{ user.avatar_url or '' }}"
  };

  function openProfileModal() {
  document.getElementById('profileModal').classList.remove('hidden');
  switchToViewProfile();
  document.getElementById('viewFullname').textContent = userProfile.fullname || '';
  document.getElementById('viewHeight').textContent = userProfile.height || 'Chưa cập nhật';
  document.getElementById('viewWeight').textContent = userProfile.weight || 'Chưa cập nhật';
  document.getElementById('viewAge').textContent = userProfile.age || 'Chưa cập nhật';
  document.getElementById('viewGender').textContent = userProfile.gender === 'male' ? 'Nam' : (userProfile.gender === 'female' ? 'Nữ' : 'Chưa cập nhật');
  document.getElementById('viewBmr').textContent = userProfile.bmr || 'Chưa có';
  document.getElementById('viewTdee').textContent = userProfile.tdee || 'Chưa có';
  document.getElementById('viewAvatar').src = userProfile.avatar_url || '';
}
  function closeProfileModal() {
    document.getElementById('profileModal').classList.add('hidden');
  }
  function switchToEditProfile() {
    document.getElementById('profileViewMode').classList.add('hidden');
    document.getElementById('profileForm').classList.remove('hidden');
    document.getElementById('profileHeight').value = userProfile.height || '';
    document.getElementById('profileWeight').value = userProfile.weight || '';
    document.getElementById('profileAge').value = userProfile.age || '';
    document.getElementById('profileGender').value = userProfile.gender || 'male';
    document.getElementById('profileAvatarUrl').value = userProfile.avatar_url || '';
    document.getElementById('profileAvatarFile').value = '';
  }
  function switchToViewProfile() {
    document.getElementById('profileViewMode').classList.remove('hidden');
    document.getElementById('profileForm').classList.add('hidden');
  }
  // Gửi form cập nhật thông tin cá nhân bằng fetch (AJAX)
  function showProfileNotice(message, success = true) {
  const notice = document.getElementById('profileNotice');
  notice.textContent = message;
  notice.className = 'mb-2 px-4 py-2 rounded font-semibold ' + (success ? 'bg-green-500' : 'bg-red-500');
  notice.style.display = '';
  setTimeout(() => { notice.style.display = 'none'; }, 2500);
}

function submitProfileForm(event) {
    event.preventDefault();
    const form = document.getElementById('profileForm');
    const formData = new FormData(form);

    // Nếu có file, thêm vào formData
    const fileInput = document.getElementById('profileAvatarFile');
    if (fileInput.files.length > 0) {
      formData.append('avatar_file', fileInput.files[0]);
    }

    fetch('/profile', {
      method: 'POST',
      body: formData,
      credentials: 'same-origin'
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        userProfile.height = data.data.height;
        userProfile.weight = data.data.weight;
        userProfile.age = data.data.age;
        userProfile.gender = data.data.gender;
        userProfile.bmr = data.data.bmr;
        userProfile.tdee = data.data.tdee;
        userProfile.avatar_url = data.data.avatar_url || '';
        switchToViewProfile();
        openProfileModal();
        showProfileNotice(data.message, true);
      } else {
        showProfileNotice(data.message || "Có lỗi xảy ra!", false);
      }
    });
    return false;
  }
</script>
  </body>
</html>
